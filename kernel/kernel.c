#include <stdint.h>
#include <descriptor_tables.h>
#include <timer.h>
#include <drivers/keyboard/ps2.h>
#include <isr.h>
#include <screen.h>
#include <mm/paging.h>
#include <mm/kheap.h>
#include <thread.h>
#include <string.h>
#include <scheduler.h>
#include <printk.h>


int fn1(void *arg);
int fn2(void *arg);
int fn3(void *arg);


void kernel_main()
{

	uint32_t *stack1, *stack2, *stack3;
	uint16_t freq;
	/* uint8_t mask; */

	char kawaii[] = {
		0x20, 0x5f, 0x20, 0x20, 0x20, 0x5f, 0x5f, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5f, 0x20, 0x5f,
		0x20, 0x5f, 0x5f, 0x5f, 0x5f, 0x5f, 0x20, 0x5f, 0x5f, 0x5f,
		0x5f, 0x5f, 0x20, 0xa, 0x7c, 0x20, 0x7c, 0x20, 0x2f, 0x20,
		0x2f, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x28, 0x5f, 0x7c, 0x5f, 0x29, 0x20, 0x20, 0x5f, 0x20, 0x20,
		0x2f, 0x20, 0x20, 0x5f, 0x5f, 0x5f, 0x7c, 0xa, 0x7c, 0x20,
		0x7c, 0x2f, 0x20, 0x2f, 0x20, 0x20, 0x5f, 0x5f, 0x20, 0x5f,
		0x5f, 0x5f, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x5f, 0x5f,
		0x5f, 0x5f, 0x20, 0x5f, 0x20, 0x5f, 0x20, 0x5f, 0x7c, 0x20,
		0x7c, 0x20, 0x7c, 0x20, 0x5c, 0x20, 0x60, 0x2d, 0x2d, 0x2e,
		0x20, 0xa, 0x7c, 0x20, 0x20, 0x20, 0x20, 0x5c, 0x20, 0x2f,
		0x20, 0x5f, 0x60, 0x20, 0x5c, 0x20, 0x5c, 0x20, 0x2f, 0x5c,
		0x20, 0x2f, 0x20, 0x2f, 0x20, 0x5f, 0x60, 0x20, 0x7c, 0x20,
		0x7c, 0x20, 0x7c, 0x20, 0x7c, 0x20, 0x7c, 0x20, 0x7c, 0x60,
		0x2d, 0x2d, 0x2e, 0x20, 0x5c, 0xa, 0x7c, 0x20, 0x7c, 0x5c,
		0x20, 0x20, 0x5c, 0x20, 0x28, 0x5f, 0x7c, 0x20, 0x7c, 0x5c,
		0x20, 0x56, 0x20, 0x20, 0x56, 0x20, 0x2f, 0x20, 0x28, 0x5f,
		0x7c, 0x20, 0x7c, 0x20, 0x7c, 0x20, 0x5c, 0x20, 0x5c, 0x5f,
		0x2f, 0x20, 0x2f, 0x5c, 0x5f, 0x5f, 0x2f, 0x20, 0x2f, 0xa,
		0x5c, 0x5f, 0x7c, 0x20, 0x5c, 0x5f, 0x2f, 0x5c, 0x5f, 0x5f,
		0x2c, 0x5f, 0x7c, 0x20, 0x5c, 0x5f, 0x2f, 0x5c, 0x5f, 0x2f,
		0x20, 0x5c, 0x5f, 0x5f, 0x2c, 0x5f, 0x7c, 0x5f, 0x7c, 0x5f,
		0x7c, 0x5c, 0x5f, 0x5f, 0x5f, 0x2f, 0x5c, 0x5f, 0x5f, 0x5f,
		0x5f, 0x2f, 0x20, 0xa, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0xa, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0xa, 0x0
	};

	cls();

	printk(kawaii);
	printk("The educational operating system, by Ahmed Khaled <nemoload@aol.com>\n");
	printk("Source code: https://github.com/nemoload/KawaiiOS\n\n");
	
	init_descriptor_tables();

	printk("[*] Global Descriptor Table updated\n");
	printk("[*] Interrupt Descriptor Table crated\n");

	keyboard_init();
	printk("[*] PS/2 driver is ready\n");



	cli();
	initialise_paging();
	sti();

	printk("[*] Paging Initialized\n");
	printk("[*] Kernel Heap Initialized\n");
	
	/* PIC */
	freq = 44000;
	init_timer(freq);
	outb(0x60,0xED|4);
	printk("[*] PIT Initialized\n");
	
	init_scheduler(init_threading());
	
	printk("[*] Kernel Threads Initialized \n");

	stack1 = (uint32_t*) kmalloc(0x400) +0x3F0;
	stack2 = (uint32_t*) kmalloc(0x400) + 0x3F0;
	stack3 = (uint32_t*) kmalloc(0x400) + 0x3F0;

	memset(stack1, 0, 0x400);
	memset(stack2, 0, 0x400);
	memset(stack3, 0, 0x400);

	create_thread(&fn1, (void*)0x567, stack1);	
	create_thread(&fn2, (void*)0x567, stack2);
	create_thread(&fn3, (void*)0x567, stack3);


}


int fn1(void *arg)
{
	int i;
	for(i=0;i<10;i++) 
	{
		print_char_at(' ',x,y,RED,RED);
		i=0;

	}
  return 0xBAD;
}

int fn2(void *arg)
{
	int i;
	for(i=0;i<10;i++) 
	{
		print_char_at(' ',x,y,GREEN,GREEN);
		i = 0;

	}
  return 0xDAD;
}

int fn3(void *arg)
{
	int i;
	for(i=0;i<10;i++) 
	{
		print_char_at(' ',x,y,BLUE,BLUE);
		i = 0;

	}
  return 0xDAD;
}